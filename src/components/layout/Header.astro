---
import Logo from '@/components/icons/Logo.astro';

interface Props {
  activePage?: 'home' | 'about' | 'experience' | 'work' | 'contact';
}

const { activePage = 'home' } = Astro.props;

const navItems = [
  { id: 'about', label: 'About', href: '/about' },
  { id: 'experience', label: 'Experience', href: '/experience' },
  { id: 'work', label: 'Work', href: '/work' }
];
---

<header id="header" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300" data-theme="light">
  <nav class="flex items-center justify-between px-4 sm:px-6 md:px-8 lg:px-12 py-4 sm:py-5 md:py-6 max-w-[1440px] mx-auto">
    <a href="/home" class="logo flex-shrink-0" aria-label="Home">
      <Logo class="w-9 h-10 sm:w-10 sm:h-11 md:w-11 md:h-12" />
    </a>

    <div class="hidden md:flex items-center gap-8 lg:gap-12">
      {navItems.map((item) => (
        <a
          href={item.href}
          class:list={[
            'nav-link relative transition-all duration-300 px-5 py-2 rounded-full',
            activePage === item.id && 'nav-link-active'
          ]}
          style="font-family: 'GT Planar', sans-serif; font-weight: 400; font-size: 17px; line-height: 25px; letter-spacing: 0px;"
          aria-current={activePage === item.id ? 'page' : undefined}
          data-nav-id={item.id}
        >
          {item.label}
        </a>
      ))}
    </div>

    <a
      href="#contact"
      class="cta-button hidden md:flex items-center justify-center px-5 py-2 rounded-full text-brand-dark transition-all duration-300 hover:scale-105 bg-accent-pink"
      style="font-family: 'GT Planar', sans-serif; font-weight: 400; font-size: 17px; line-height: 25px; letter-spacing: 0px;"
    >
      Reach Out!
    </a>

    <button
      id="mobile-menu-btn"
      class="md:hidden flex flex-col gap-1.5 p-2"
      aria-label="Toggle menu"
      aria-expanded="false"
    >
      <span class="hamburger-line w-6 h-0.5 transition-all origin-center"></span>
      <span class="hamburger-line w-6 h-0.5 transition-all"></span>
      <span class="hamburger-line w-6 h-0.5 transition-all origin-center"></span>
    </button>
  </nav>

  <div
    id="mobile-menu"
    class="fixed inset-0 bg-slide-pink z-40 translate-x-full transition-transform duration-300 md:hidden"
  >
    <div class="flex flex-col items-center justify-center h-full gap-8">
      {navItems.map((item) => (
        <a
          href={item.href}
          class:list={[
            'mobile-nav-link text-brand-dark px-6 py-2 rounded-full transition-colors duration-300',
            activePage === item.id && 'mobile-nav-link-active'
          ]}
          style="font-family: 'GT Planar', sans-serif; font-weight: 400; font-size: 24px; line-height: 32px; letter-spacing: 0px;"
        >
          {item.label}
        </a>
      ))}
      <a
        href="#contact"
        class="mobile-cta-button mt-4 px-8 py-3 rounded-full text-brand-dark transition-colors duration-300 bg-accent-pink"
        style="font-family: 'GT Planar', sans-serif; font-weight: 400; font-size: 24px; line-height: 32px; letter-spacing: 0px;"
      >
        Reach Out!
      </a>
    </div>
  </div>
</header>

<script>
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  const header = document.getElementById('header');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const ctaButton = document.querySelector('.cta-button') as HTMLElement;
  const mobileCta = document.querySelector('.mobile-cta-button') as HTMLElement;
  const navLinks = document.querySelectorAll('.nav-link');
  let lastScrollY = 0;
  let isMenuOpen = false;

  const allAccentColors = ['bg-accent-pink', 'bg-accent-blue', 'bg-accent-yellow', 'bg-accent-orange'];

  const accentColorMap: Record<string, string> = {
    'bg-accent-pink': 'var(--color-accent-pink)',
    'bg-accent-blue': 'var(--color-accent-blue)',
    'bg-accent-yellow': 'var(--color-accent-yellow)',
    'bg-accent-orange': 'var(--color-accent-orange)'
  };

  let currentAccentColor = 'bg-accent-pink';

  window.addEventListener('slideChange', ((event: CustomEvent) => {
    const { accentColor } = event.detail;
    currentAccentColor = accentColor;

    if (ctaButton) {
      allAccentColors.forEach(color => ctaButton.classList.remove(color));
      ctaButton.classList.add(accentColor);
    }

    if (mobileCta) {
      allAccentColors.forEach(color => mobileCta.classList.remove(color));
      mobileCta.classList.add(accentColor);
    }

    const colorValue = accentColorMap[accentColor] || accentColorMap['bg-accent-pink'];
    document.documentElement.style.setProperty('--nav-hover-color', colorValue);
    document.documentElement.style.setProperty('--nav-active-bg', colorValue);

    const activeNavLink = document.querySelector('.nav-link-active') as HTMLElement;
    const activeMobileNavLink = document.querySelector('.mobile-nav-link-active') as HTMLElement;

    if (activeNavLink) {
      allAccentColors.forEach(color => activeNavLink.classList.remove(color));
      activeNavLink.classList.add(accentColor);
    }

    if (activeMobileNavLink) {
      allAccentColors.forEach(color => activeMobileNavLink.classList.remove(color));
      activeMobileNavLink.classList.add(accentColor);
    }
  }) as EventListener);

  // Header always visible - no hide on scroll behavior
  // This ensures navigation is always accessible
  if (header) {
    gsap.set(header, { y: 0 });
  }

  // Dynamic theme detection based on background color
  function updateHeaderTheme() {
    if (!header) return;

    const headerRect = header.getBoundingClientRect();
    const headerMiddleY = headerRect.top + headerRect.height / 2;
    const headerMiddleX = window.innerWidth / 2;

    // Get element behind the header
    header.style.pointerEvents = 'none';
    const elementBehind = document.elementFromPoint(headerMiddleX, headerMiddleY);
    header.style.pointerEvents = '';

    if (!elementBehind) return;

    // Get computed background color
    let bgColor = '';
    let currentEl: Element | null = elementBehind;

    while (currentEl && currentEl !== document.body) {
      const style = window.getComputedStyle(currentEl);
      const bg = style.backgroundColor;

      if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') {
        bgColor = bg;
        break;
      }
      currentEl = currentEl.parentElement;
    }

    // If no background found, check body
    if (!bgColor) {
      bgColor = window.getComputedStyle(document.body).backgroundColor;
    }

    // Parse RGB values
    const rgbMatch = bgColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
    if (rgbMatch) {
      const r = parseInt(rgbMatch[1]);
      const g = parseInt(rgbMatch[2]);
      const b = parseInt(rgbMatch[3]);

      // Calculate luminance
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

      // Switch theme based on luminance
      const isDark = luminance < 0.5;
      const currentTheme = header.dataset.theme;
      const newTheme = isDark ? 'dark' : 'light';

      // Always apply the class (even on first run)
      header.classList.remove('header-light', 'header-dark');
      header.classList.add(`header-${newTheme}`);
      header.dataset.theme = newTheme;
    }
  }

  // Update on scroll and resize
  window.addEventListener('scroll', updateHeaderTheme, { passive: true });
  window.addEventListener('resize', updateHeaderTheme, { passive: true });

  // Initial update
  updateHeaderTheme();
  setTimeout(updateHeaderTheme, 100);
  setTimeout(updateHeaderTheme, 500);

  mobileMenuBtn?.addEventListener('click', () => {
    isMenuOpen = !isMenuOpen;
    const spans = mobileMenuBtn.querySelectorAll('span');

    if (isMenuOpen) {
      mobileMenu?.classList.remove('translate-x-full');
      mobileMenuBtn.setAttribute('aria-expanded', 'true');
      gsap.to(spans[0], { rotation: 45, y: 6, duration: 0.3 });
      gsap.to(spans[1], { opacity: 0, duration: 0.3 });
      gsap.to(spans[2], { rotation: -45, y: -6, duration: 0.3 });

      gsap.from('.mobile-nav-link', {
        opacity: 0,
        x: 50,
        stagger: 0.1,
        duration: 0.4,
        ease: 'power3.out',
        delay: 0.2
      });
    } else {
      mobileMenu?.classList.add('translate-x-full');
      mobileMenuBtn.setAttribute('aria-expanded', 'false');
      gsap.to(spans[0], { rotation: 0, y: 0, duration: 0.3 });
      gsap.to(spans[1], { opacity: 1, duration: 0.3 });
      gsap.to(spans[2], { rotation: 0, y: 0, duration: 0.3 });
    }
  });

  document.querySelectorAll('.mobile-nav-link').forEach(link => {
    link.addEventListener('click', () => {
      isMenuOpen = false;
      mobileMenu?.classList.add('translate-x-full');
      const spans = mobileMenuBtn?.querySelectorAll('span');
      if (spans) {
        gsap.to(spans[0], { rotation: 0, y: 0, duration: 0.3 });
        gsap.to(spans[1], { opacity: 1, duration: 0.3 });
        gsap.to(spans[2], { rotation: 0, y: 0, duration: 0.3 });
      }
    });
  });
</script>

<style>
  :root {
    --nav-hover-color: var(--color-accent-pink);
    --nav-active-bg: var(--color-accent-pink);
  }

  /* Header is transparent - takes background from page */
  #header {
    background-color: transparent;
  }

  /* Light theme (default) - for light backgrounds */
  .header-light .nav-link {
    color: var(--color-brand-dark, #231F20);
  }

  .header-light .hamburger-line {
    background-color: var(--color-brand-dark, #231F20);
  }

  /* Dark theme - for dark backgrounds */
  .header-dark .nav-link {
    color: white;
  }

  .header-dark .nav-link:hover {
    background-color: white;
    color: var(--color-brand-dark, #231F20) !important;
  }

  .header-dark .nav-link-active {
    background-color: white;
    color: var(--color-brand-dark, #231F20);
  }

  .header-dark .cta-button {
    background-color: white !important;
    color: var(--color-brand-dark, #231F20);
  }

  .header-dark .hamburger-line {
    background-color: white;
  }

  /* Logo color change for dark theme */
  .header-dark .logo svg path:first-child {
    fill: white;
  }

  .header-dark .logo svg path[fill="#231F20"]:not(:first-child) {
    fill: white;
  }

  /* Light theme hover */
  .header-light .nav-link:hover:not(.nav-link-active) {
    color: var(--nav-hover-color);
  }

  .header-light .nav-link-active {
    background-color: var(--nav-active-bg);
  }

  .mobile-nav-link-active {
    background-color: var(--nav-active-bg);
  }
</style>
